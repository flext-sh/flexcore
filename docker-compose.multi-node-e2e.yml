services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: flexcore-postgres
    environment:
      POSTGRES_DB: flexcore
      POSTGRES_USER: flexcore
      POSTGRES_PASSWORD: flexcore123
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U flexcore"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: flexcore-redis
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Mock Windmill Server
  mock-windmill:
    image: nginx:alpine
    container_name: mock-windmill
    ports:
      - "8000:8000"
    volumes:
      - ./docker/mock-windmill.conf:/etc/nginx/conf.d/default.conf
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/version"]
      interval: 10s
      timeout: 5s
      retries: 5

  # HAProxy Load Balancer
  haproxy:
    image: haproxy:alpine
    container_name: flexcore-haproxy
    ports:
      - "8080:8080"  # Cluster endpoint
      - "8404:8404"  # Stats page
    volumes:
      - ./docker/haproxy/haproxy-cluster.cfg:/usr/local/etc/haproxy/haproxy.cfg
    depends_on:
      - flexcore-node1
      - flexcore-node2
      - flexcore-node3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8404/stats"]
      interval: 10s
      timeout: 5s
      retries: 5

  # FlexCore Node 1 (Leader candidate)
  flexcore-node1:
    build:
      context: .
      dockerfile: docker/Dockerfile.flexcore-node
    container_name: flexcore-node1
    environment:
      NODE_ID: node-1
      NODE_TYPE: leader-candidate
      CLUSTER_SIZE: 3
      HTTP_PORT: 8001
      WINDMILL_URL: http://mock-windmill:8000
      WINDMILL_TOKEN: wm_dummy_token
      POSTGRES_URL: postgresql://flexcore:flexcore123@postgres:5432/flexcore
      REDIS_URL: redis://redis:6379
      LOG_LEVEL: info
      PLUGIN_DIR: /app/plugins
    ports:
      - "8001:8001"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      mock-windmill:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # FlexCore Node 2 (Worker)
  flexcore-node2:
    build:
      context: .
      dockerfile: docker/Dockerfile.flexcore-node
    container_name: flexcore-node2
    environment:
      NODE_ID: node-2
      NODE_TYPE: worker
      CLUSTER_SIZE: 3
      HTTP_PORT: 8002
      WINDMILL_URL: http://mock-windmill:8000
      WINDMILL_TOKEN: wm_dummy_token
      POSTGRES_URL: postgresql://flexcore:flexcore123@postgres:5432/flexcore
      REDIS_URL: redis://redis:6379
      LOG_LEVEL: info
      PLUGIN_DIR: /app/plugins
    ports:
      - "8002:8002"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      mock-windmill:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # FlexCore Node 3 (Worker)
  flexcore-node3:
    build:
      context: .
      dockerfile: docker/Dockerfile.flexcore-node
    container_name: flexcore-node3
    environment:
      NODE_ID: node-3
      NODE_TYPE: worker
      CLUSTER_SIZE: 3
      HTTP_PORT: 8003
      WINDMILL_URL: http://mock-windmill:8000
      WINDMILL_TOKEN: wm_dummy_token
      POSTGRES_URL: postgresql://flexcore:flexcore123@postgres:5432/flexcore
      REDIS_URL: redis://redis:6379
      LOG_LEVEL: info
      PLUGIN_DIR: /app/plugins
    ports:
      - "8003:8003"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      mock-windmill:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # E2E Test Runner
  e2e-test:
    build:
      context: .
      dockerfile: docker/Dockerfile.e2e-test
    container_name: flexcore-e2e-test
    environment:
      FLEXCORE_CLUSTER_URL: http://flexcore-node1:8001
      WINDMILL_URL: http://mock-windmill:8000
      POSTGRES_URL: postgresql://flexcore:flexcore123@postgres:5432/flexcore
      TEST_TIMEOUT: 300s
      CLUSTER_NODES: flexcore-node1:8001,flexcore-node2:8002,flexcore-node3:8003
    volumes:
      - ./test-results:/app/results
    depends_on:
      flexcore-node1:
        condition: service_healthy
      flexcore-node2:
        condition: service_healthy
      flexcore-node3:
        condition: service_healthy
    profiles:
      - test

volumes:
  postgres_data: