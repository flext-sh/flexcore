# Mock API Server Configuration for FlexCore E2E Testing

server {
    listen 80;
    server_name localhost;

    # Enable CORS for testing
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Accept, Authorization, Cache-Control, Content-Type, DNT, If-Modified-Since, Keep-Alive, Origin, User-Agent, X-Requested-With' always;

    # Handle preflight requests
    location / {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Accept, Authorization, Cache-Control, Content-Type, DNT, If-Modified-Since, Keep-Alive, Origin, User-Agent, X-Requested-With';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }
        try_files $uri $uri/ @dynamic;
    }

    # Health check endpoint
    location /health {
        return 200 '{"status": "healthy", "timestamp": "$time_iso8601", "service": "mock-api"}';
        add_header Content-Type application/json;
    }

    # Data loading endpoint
    location /api/data {
        if ($request_method = POST) {
            return 200 '{"status": "success", "message": "Data loaded successfully", "timestamp": "$time_iso8601", "records_received": 0}';
        }
        return 405 '{"error": "Method not allowed"}';
        add_header Content-Type application/json;
    }

    # Batch loading endpoint
    location /api/batch {
        if ($request_method = POST) {
            return 200 '{"status": "success", "message": "Batch loaded successfully", "timestamp": "$time_iso8601", "batch_id": "$request_id"}';
        }
        return 405 '{"error": "Method not allowed"}';
        add_header Content-Type application/json;
    }

    # Processed data endpoint
    location /api/processed {
        if ($request_method = POST) {
            return 201 '{"status": "created", "message": "Processed data stored", "timestamp": "$time_iso8601", "id": "$request_id"}';
        }
        if ($request_method = GET) {
            return 200 '{"status": "success", "data": [], "count": 0, "timestamp": "$time_iso8601"}';
        }
        return 405 '{"error": "Method not allowed"}';
        add_header Content-Type application/json;
    }

    # Error simulation endpoints
    location /api/error/400 {
        return 400 '{"error": "Bad Request", "message": "Simulated client error", "timestamp": "$time_iso8601"}';
        add_header Content-Type application/json;
    }

    location /api/error/500 {
        return 500 '{"error": "Internal Server Error", "message": "Simulated server error", "timestamp": "$time_iso8601"}';
        add_header Content-Type application/json;
    }

    location /api/slow {
        # Simulate slow response
        set $delay 2;
        echo_sleep $delay;
        return 200 '{"status": "success", "message": "Slow response", "delay_seconds": 2, "timestamp": "$time_iso8601"}';
        add_header Content-Type application/json;
    }

    # Dynamic responses
    location @dynamic {
        # Log requests for debugging
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;
        
        # Default dynamic response
        return 200 '{"status": "success", "endpoint": "$uri", "method": "$request_method", "timestamp": "$time_iso8601", "request_id": "$request_id"}';
        add_header Content-Type application/json;
    }

    # Webhook endpoint for testing notifications
    location /webhook {
        if ($request_method = POST) {
            return 200 '{"status": "webhook_received", "timestamp": "$time_iso8601", "request_id": "$request_id"}';
        }
        return 405 '{"error": "Method not allowed"}';
        add_header Content-Type application/json;
    }

    # Status endpoint
    location /status {
        return 200 '{"status": "running", "version": "1.0.0", "timestamp": "$time_iso8601", "uptime": "$upstream_response_time"}';
        add_header Content-Type application/json;
    }
}