# FlexCore - Enterprise Development Environment
# ===========================================
# Clean Architecture + DDD + CQRS + Event Sourcing + Observability Stack
# Integrated with FLEXT Python ecosystem

services:
  # ============================================================================
  # üèóÔ∏è FLEXCORE CORE SERVICES - Go 1.24
  # ============================================================================
  
  flexcore-server:
    build:
      context: .
      dockerfile: deployments/docker/Dockerfile
      target: development
    container_name: flexcore-server
    hostname: flexcore-server
    ports:
      - "8080:8080"     # HTTP API
      - "50051:50051"   # gRPC API
      - "9090:9090"     # Metrics
    environment:
      # Core Configuration
      - FLEXCORE_ENV=development
      - FLEXCORE_DEBUG=true
      - FLEXCORE_PORT=8080
      - FLEXCORE_GRPC_PORT=50051
      - FLEXCORE_METRICS_PORT=9090
      
      # Database Configuration
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=flexcore
      - POSTGRES_USER=flexcore
      - POSTGRES_PASSWORD=flexcore_dev_2025
      
      # Redis Configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=""
      - REDIS_DB=0
      
      # Event Sourcing Configuration
      - EVENT_STORE_TYPE=postgres
      - EVENT_STORE_CONNECTION=postgres://flexcore:flexcore_dev_2025@postgres:5432/flexcore_events
      
      # CQRS Configuration
      - COMMAND_BUS_TYPE=redis
      - QUERY_BUS_TYPE=redis
      - EVENT_BUS_TYPE=redis
      
      # Observability Configuration
      - OTEL_SERVICE_NAME=flexcore
      - OTEL_RESOURCE_ATTRIBUTES=service.name=flexcore,service.version=0.9.0
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:14268/api/traces
      - PROMETHEUS_ENDPOINT=http://prometheus:9090
      
      # Plugin System Configuration
      - PLUGIN_DIR=/app/plugins
      - PLUGIN_AUTO_DISCOVERY=true
      
      # Integration with FLEXT Service
      - FLEXT_SERVICE_HOST=internal.invalid
      - FLEXT_SERVICE_PORT=8000
      - FLEXT_SERVICE_URL=https://internal.invalid/REDACTED:8000
      - FLEXT_CONFIG_PATH=/home/marlonsc/flext/config.yaml
    volumes:
      - ./plugins:/app/plugins:ro
      - ./configs:/app/configs:ro
      - ./logs:/app/logs
      - flexcore_cache:/app/cache
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - flexcore-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ============================================================================
  # üóÑÔ∏è DATA LAYER - PostgreSQL + Redis
  # ============================================================================
  
  postgres:
    image: postgres:15-alpine
    container_name: flexcore-postgres
    hostname: flexcore-postgres
    ports:
      - "5433:5432"
    environment:
      POSTGRES_DB: flexcore
      POSTGRES_USER: flexcore
      POSTGRES_PASSWORD: flexcore_dev_2025
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - flexcore-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U flexcore -d flexcore"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    command: >
      postgres
      -c shared_preload_libraries=pg_stat_statements
      -c pg_stat_statements.max=10000
      -c pg_stat_statements.track=all
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.7
      -c wal_buffers=16MB
      -c default_statistics_target=100

  redis:
    image: redis:7-alpine
    container_name: flexcore-redis
    hostname: flexcore-redis
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    networks:
      - flexcore-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    command: redis-server

  # ============================================================================
  # üìä OBSERVABILITY STACK - Prometheus + Grafana + Jaeger
  # ============================================================================
  
  prometheus:
    image: prom/prometheus:v2.45.0
    container_name: flexcore-prometheus
    hostname: flexcore-prometheus
    ports:
      - "9091:9090"  # Changed to avoid conflicts with FlexCore metrics port
    volumes:
      - ./deployments/docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./deployments/docker/prometheus/rules:/etc/prometheus/rules:ro
      - prometheus_data:/prometheus
    networks:
      - flexcore-network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
      - '--web.enable-REDACTED_LDAP_BIND_PASSWORD-api'
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.0.0
    container_name: flexcore-grafana
    hostname: flexcore-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=flexcore_REDACTED_LDAP_BIND_PASSWORD_2025
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-piechart-panel,grafana-worldmap-panel
    volumes:
      - grafana_data:/var/lib/grafana
      - ./deployments/docker/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./deployments/docker/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    networks:
      - flexcore-network
    depends_on:
      - prometheus
    restart: unless-stopped

  jaeger:
    image: jaegertracing/all-in-one:1.47
    container_name: flexcore-jaeger
    hostname: flexcore-jaeger
    ports:
      - "14268:14268"  # HTTP collector
      - "16686:16686"  # Web UI
      - "14250:14250"  # gRPC collector
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - SPAN_STORAGE_TYPE=memory
    networks:
      - flexcore-network
    restart: unless-stopped

  # ============================================================================
  # üîß DEVELOPMENT TOOLS
  # ============================================================================
  
  REDACTED_LDAP_BIND_PASSWORDer:
    image: REDACTED_LDAP_BIND_PASSWORDer:4.8.1
    container_name: flexcore-REDACTED_LDAP_BIND_PASSWORDer
    hostname: flexcore-REDACTED_LDAP_BIND_PASSWORDer
    ports:
      - "8081:8080"
    environment:
      - ADMINER_DEFAULT_SERVER=postgres
      - ADMINER_DESIGN=pepa-linha-dark
    networks:
      - flexcore-network
    depends_on:
      - postgres
    restart: unless-stopped

  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: flexcore-redis-commander
    hostname: flexcore-redis-commander
    ports:
      - "8082:8081"
    environment:
      - REDIS_HOSTS=local:redis:6379
    networks:
      - flexcore-network
    depends_on:
      - redis
    restart: unless-stopped


# ============================================================================
# üíæ VOLUMES - Persistent Data
# ============================================================================

volumes:
  postgres_data:
    driver: local
    name: flexcore_postgres_data
  redis_data:
    driver: local
    name: flexcore_redis_data
  prometheus_data:
    driver: local
    name: flexcore_prometheus_data
  grafana_data:
    driver: local
    name: flexcore_grafana_data
  flexcore_cache:
    driver: local
    name: flexcore_cache_data

# ============================================================================
# üåê NETWORKS - Service Communication
# ============================================================================

networks:
  flexcore-network:
    driver: bridge
    name: flexcore-network
    ipam:
      config:
        - subnet: 172.25.0.0/16
  

# ============================================================================
# üè∑Ô∏è LABELS - Metadata for Container Management
# ============================================================================

x-common-labels: &common-labels
  com.flext.project: "flexcore"
  com.flext.environment: "development"
  com.flext.maintainer: "FLEXT Team"
  com.flext.documentation: "https://github.com/flext/flexcore"
  com.flext.version: "0.9.0"

# Apply labels to all services
x-service-defaults: &service-defaults
  labels:
    <<: *common-labels