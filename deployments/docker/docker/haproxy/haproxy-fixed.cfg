global
    daemon
    log stdout local0 info
    
defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option httplog
    log global

# Statistics page
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# FlexCore Cluster Frontend
frontend flexcore_cluster
    bind *:8080
    option httplog
    default_backend flexcore_nodes

# FlexCore Nodes Backend with DNS resolution
backend flexcore_nodes
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    # Use IP resolution for container names
    server node1 flexcore-node1:8001 check inter 10s fall 3 rise 2 resolvers docker init-addr none
    server node2 flexcore-node2:8002 check inter 10s fall 3 rise 2 resolvers docker init-addr none  
    server node3 flexcore-node3:8003 check inter 10s fall 3 rise 2 resolvers docker init-addr none

# Docker DNS resolver
resolvers docker
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry 1s
    hold other 10s
    hold refused 10s
    hold nx 10s
    hold timeout 10s
    hold valid 10s
    hold obsolete 10s

# Leader-only endpoints (for admin operations)
frontend flexcore_leader
    bind *:8081
    option httplog
    default_backend flexcore_leader_node

backend flexcore_leader_node
    option httpchk GET /health
    http-check expect status 200
    
    # Route admin operations to leader candidate
    server leader flexcore-node1:8001 check inter 10s fall 3 rise 2 resolvers docker init-addr none